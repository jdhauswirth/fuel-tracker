<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fuel Tracker">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Fuel Tracker</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            padding: 20px 30px 10px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 5px;
            font-size: 24px;
            font-weight: bold;
        }
        
        .vehicle-info {
            color: #333;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: normal;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 15px;
            font-size: 10pt;
            font-weight: normal;
            margin-top: 0;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            color: #2E7D32;
            border-bottom: 3px solid #2E7D32;
        }
        
        .tab:hover {
            background: #e8e8e8;
        }
        
        .tab.active:hover {
            background: white;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .status {
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            display: block;
        }
        
        .status.success {
            background: #e8f5e9;
            color: #388e3c;
            display: block;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #2E7D32;
        }
        
        .calculated {
            background: #f5f5f5;
            color: #666;
        }
        
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.4);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .config-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .config-section h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        #loginSection {
            text-align: center;
        }
        
        #appContent {
            display: none;
        }
        
        .info-text {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        
        .input-with-buttons {
            display: flex;
            gap: 5px;
            align-items: stretch;
        }
        
        .input-with-buttons input {
            flex: 1;
        }
        
        .adjust-btn {
            width: 45px;
            padding: 12px;
            background: #2E7D32;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .adjust-btn:hover {
            background: #388E3C;
        }
        
        .adjust-btn:active {
            background: #1B5E20;
        }
        
        .history-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .history-item {
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #2E7D32;
        }
        
        .history-item-date {
            font-weight: bold;
            color: #2E7D32;
            margin-bottom: 5px;
        }
        
        .history-item-detail {
            font-size: 13px;
            color: #555;
            margin: 3px 0;
        }
        
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .summary-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }
        
        .summary-table tr:last-child td {
            border-bottom: none;
        }
        
        .summary-label {
            font-weight: 600;
            color: #333;
            width: 60%;
        }
        
        .summary-value {
            text-align: right;
            color: #2E7D32;
            font-weight: 600;
        }
        
        .secondary-btn {
            background: #666;
            margin-top: 10px;
        }
        
        .receipt-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 8px;
            width: auto;
            display: inline-block;
        }
        
        .receipt-btn:hover {
            background: #1976D2;
        }
        
        .receipt-image {
            max-width: 100%;
            margin-top: 10px;
            border-radius: 8px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .receipt-image.show {
            display: block;
        }
        
        #receiptPreview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚õΩ Mileage & Fuel Tracker:</h1>
            <p class="vehicle-info">Joel H. - 2018 Subaru Outback 2.5L Limited</p>
            <p class="vehicle-info">VIN: ending -0616</p>
            <p class="subtitle">(Logs fuel stops to Google Sheet)</p>
        </div>
        
        <div id="status" class="status" style="margin: 0 30px 20px;"></div>
        
        <div id="loginSection" style="padding: 0 30px 30px;">
            <div class="config-section">
                <h3>Setup Required</h3>
                <p>Configure your Google Cloud Project credentials.</p>
                <br>
                <label>Google Client ID:</label>
                <input type="text" id="clientId" placeholder="Your Google Client ID">
                <p class="info-text">From Google Cloud Console</p>
                <br>
                <label>Google API Key:</label>
                <input type="text" id="apiKey" placeholder="Your Google API Key">
                <p class="info-text">From Google Cloud Console</p>
                <br>
                <label>Spreadsheet ID:</label>
                <input type="text" id="spreadsheetId" placeholder="From your Google Sheets URL">
                <p class="info-text">Found in the URL of your spreadsheet</p>
                <br>
                <label>Sheet Name:</label>
                <input type="text" id="sheetName" placeholder="Mileage & Refueling" value="Mileage & Refueling">
            </div>
            <button id="signInBtn">Sign in with Google</button>
        </div>
        
        <div id="appContent">
            <div class="tabs">
                <button class="tab active" id="logTabBtn">üìù Log Fuel</button>
                <button class="tab" id="historyTabBtn">üìä History</button>
                <button class="tab" id="summaryTabBtn">üìà Summary</button>
                <button class="tab" id="shortcutsTabBtn">‚ö° Shortcuts</button>
            </div>
            
            <div id="logTab" class="tab-content active">
                <div id="lastFillInfo" style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-bottom: 20px; display: none;">
                    <strong>Last Fill-up:</strong>
                    <div style="margin-top: 5px; font-size: 14px;" id="lastFillDetails"></div>
                </div>
                
                <form id="fuelForm">
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="odometer">Odometer (current)</label>
                        <div class="input-with-buttons">
                            <button type="button" class="adjust-btn" id="odoMinusBtn">-</button>
                            <input type="text" id="odometer" placeholder="Current mileage" required>
                            <button type="button" class="adjust-btn" id="odoPlusBtn">+</button>
                        </div>
                        <input type="hidden" id="odometerValue">
                    </div>
                    
                    <div class="form-group">
                        <label for="milesFill">Miles/Fill</label>
                        <div class="input-with-buttons">
                            <button type="button" class="adjust-btn" id="milesMinusBtn">-</button>
                            <input type="number" id="milesFill" step="0.1" placeholder="Miles driven">
                            <button type="button" class="adjust-btn" id="milesPlusBtn">+</button>
                        </div>
                        <p class="info-text">Auto-calculated, but you can adjust to match your trip odometer</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="fuelType">Fuel Type</label>
                        <select id="fuelType" required>
                            <option value="">Select...</option>
                            <option value="R87" selected>R87</option>
                            <option value="P91">P91</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="gallons">Gallons</label>
                        <div class="input-with-buttons">
                            <button type="button" class="adjust-btn" id="gallonsMinusBtn">-</button>
                            <input type="number" id="gallons" step="0.001" value="13.500" placeholder="0.000" required>
                            <button type="button" class="adjust-btn" id="gallonsPlusBtn">+</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="mpg">MPG (estimated - not saved)</label>
                        <input type="number" id="mpg" step="0.01" class="calculated" readonly>
                        <p class="info-text">Preview only - your sheet formula will calculate the actual MPG</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="pricePerGal">$/Gal</label>
                        <div class="input-with-buttons">
                            <button type="button" class="adjust-btn" id="priceMinusBtn">-</button>
                            <input type="number" id="pricePerGal" step="0.001" placeholder="0.000" required>
                            <button type="button" class="adjust-btn" id="pricePlusBtn">+</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" list="locationList" placeholder="Select or type location" value="COSTCO SOS" required>
                        <datalist id="locationList">
                            <option value="COSTCO SOS">
                            <option value="COSTCO GSE">
                        </datalist>
                    </div>
                    
                    <div class="form-group">
                        <label for="receipt">üì∑ Receipt Image (optional)</label>
                        <input type="file" id="receipt" accept="image/*" style="padding: 8px;">
                        <p class="info-text">Choose from gallery or take a new photo</p>
                        <div id="receiptPreview" style="margin-top: 10px;"></div>
                    </div>
                    
                    <button type="submit">Log Fuel Stop</button>
                </form>
                
                <button id="signOutBtn" class="secondary-btn">Sign Out</button>
            </div>
            
            <div id="historyTab" class="tab-content">
                <button id="refreshHistoryBtn" style="margin-bottom: 20px;">üîÑ Refresh History</button>
                <div id="historyList" class="history-list">
                    <p style="text-align: center; color: #999;">Click "Refresh History" to load your fuel stops</p>
                </div>
            </div>
            
            <div id="summaryTab" class="tab-content">
                <button id="refreshSummaryBtn" style="margin-bottom: 20px;">üîÑ Refresh Summary</button>
                <div id="summaryContent" style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
                    <p style="text-align: center; color: #999;">Click "Refresh Summary" to load statistics</p>
                </div>
            </div>
            
            <div id="shortcutsTab" class="tab-content">
                <h3 style="margin-bottom: 15px;">‚ö° Auto-Launch at Gas Station</h3>
                
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin-bottom: 10px;"><strong>üì± Add to Home Screen First!</strong></p>
                    <p style="font-size: 13px; margin: 5px 0;">For best experience:</p>
                    <ol style="font-size: 13px; margin-left: 20px; line-height: 1.6;">
                        <li>In Safari, tap the Share button (square with arrow)</li>
                        <li>Tap "Add to Home Screen"</li>
                        <li>Name it "Fuel Tracker"</li>
                        <li>Tap Add</li>
                    </ol>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">Now it opens like a native app!</p>
                </div>
                
                <button id="shortcutInstructionsBtn" style="background: #2196F3;">
                    üìñ View Setup Instructions
                </button>
                
                <div id="shortcutInstructions" style="display: none; margin-top: 20px; background: #f9f9f9; padding: 20px; border-radius: 8px; font-size: 13px; line-height: 1.6;">
                    <h4 style="margin-bottom: 15px;">üì± Apple Shortcuts Setup Guide</h4>
                    <p style="margin-bottom: 15px;"><strong>Step 1:</strong> Create location automation in Shortcuts app</p>
                    <p style="margin-bottom: 15px;"><strong>Step 2:</strong> Set location to your gas station</p>
                    <p style="margin-bottom: 15px;"><strong>Step 3:</strong> Add "Open URL" action with this app's URL</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        var tokenClient;
        var accessToken = null;
        var lastOdometer = null;
        var gapiInited = false;
        var gisInited = false;
        var driveFolder = null;
        var DISCOVERY_DOC = 'https://sheets.googleapis.com/\x24discovery/rest?version=v4';
        var SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
        var isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
        
        function setTodayDate() {
            var today = new Date();
            var year = today.getFullYear();
            var month = String(today.getMonth() + 1).padStart(2, '0');
            var day = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = year + '-' + month + '-' + day;
        }
        
        function showTab(tabName) {
            var tabs = document.querySelectorAll('.tab-content');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            var buttons = document.querySelectorAll('.tab');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        function showStatus(message, type) {
            if (!type) type = 'info';
            var status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            if (isStandalone && type === 'success') {
                status.textContent += ' üì±';
            }
        }
        
        function gapiLoaded() {
            console.log('GAPI loaded');
            gapi.load('client', initializeGapiClient);
        }
        
        function initializeGapiClient() {
            console.log('Initializing GAPI');
            var apiKey = localStorage.getItem('fuelTracker_apiKey') || document.getElementById('apiKey').value;
            if (!apiKey) return;
            
            gapi.client.init({
                apiKey: apiKey,
                discoveryDocs: [DISCOVERY_DOC]
            }).then(function() {
                gapiInited = true;
                console.log('GAPI initialized');
            });
        }
        
        function gisLoaded() {
            console.log('GIS loaded');
            var clientId = localStorage.getItem('fuelTracker_clientId') || document.getElementById('clientId').value;
            if (!clientId) return;
            
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: SCOPES,
                callback: ''
            });
            gisInited = true;
            console.log('GIS initialized');
        }
        
        function handleAuthClick() {
            console.log('Auth clicked');
            var clientId = document.getElementById('clientId').value.trim();
            var apiKey = document.getElementById('apiKey').value.trim();
            var spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            var sheetName = document.getElementById('sheetName').value.trim();
            
            if (!clientId || !apiKey || !spreadsheetId) {
                showStatus('Please fill in all configuration fields', 'error');
                return;
            }
            
            localStorage.setItem('fuelTracker_clientId', clientId);
            localStorage.setItem('fuelTracker_apiKey', apiKey);
            localStorage.setItem('fuelTracker_spreadsheetId', spreadsheetId);
            localStorage.setItem('fuelTracker_sheetName', sheetName);
            
            if (!gapiInited || !gisInited) {
                showStatus('Please wait for Google APIs to load...', 'info');
                setTimeout(handleAuthClick, 2000);
                return;
            }
            
            tokenClient.callback = function(resp) {
                if (resp.error !== undefined) {
                    showStatus('Authentication failed: ' + resp.error, 'error');
                    return;
                }
                accessToken = resp.access_token;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                showStatus('Signed in successfully!', 'success');
                loadLastOdometer();
            };
            
            if (accessToken === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        function handleSignoutClick() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
                accessToken = null;
            }
            location.reload();
        }
        
        function calculateMPG() {
            var milesFill = parseFloat(document.getElementById('milesFill').value);
            var gallons = parseFloat(document.getElementById('gallons').value);
            if (milesFill > 0 && gallons > 0) {
                var mpg = milesFill / gallons;
                document.getElementById('mpg').value = mpg.toFixed(2);
            }
        }
        
        function calculateValues() {
            var odometerStr = document.getElementById('odometerValue').value;
            var odometer = parseFloat(odometerStr);
            
            if (lastOdometer && odometer && odometer <= lastOdometer) {
                showStatus('Error: Current odometer must be greater than prior odometer (' + lastOdometer.toLocaleString() + ')', 'error');
                document.getElementById('milesFill').value = '';
                document.getElementById('gallons').value = '13.500';
                document.getElementById('mpg').value = '';
                return;
            }
            
            if (lastOdometer && odometer && odometer > lastOdometer) {
                var milesFill = odometer - lastOdometer;
                document.getElementById('milesFill').value = milesFill.toFixed(1);
                var expectedGallons = milesFill / 26.1;
                document.getElementById('gallons').value = expectedGallons.toFixed(3);
                var mpg = milesFill / expectedGallons;
                document.getElementById('mpg').value = mpg.toFixed(2);
                showStatus('Ready for next entry', 'info');
            }
        }
        
        function loadLastOdometer() {
            var spreadsheetId = localStorage.getItem('fuelTracker_spreadsheetId');
            var sheetName = localStorage.getItem('fuelTracker_sheetName');
            
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: spreadsheetId,
                range: sheetName + '!B:P'
            }).then(function(response) {
                var values = response.result.values;
                var dataRows = values ? values.filter(function(row) {
                    return row && row.length >= 2 && row[0] && String(row[0]).trim() !== '' && row[1] && String(row[1]).trim() !== '';
                }) : [];
                
                var historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                
                if (dataRows && dataRows.length > 1) {
                    for (var i = dataRows.length - 1; i >= 1; i--) {
                        var row = dataRows[i];
                        var gallons = parseFloat(row[4]) || 0;
                        var pricePerGal = parseFloat(String(row[6]).replace(/[\$,\s]/g, '')) || 0;
                        var totalCost = (gallons * pricePerGal).toFixed(2);
                        var receiptFileId = row[14] || null;
                        
                        var item = document.createElement('div');
                        item.className = 'history-item';
                        var costLine = row[4] + ' gallons @ ' + row[6] + '/gal = 
                var values = response.result.values;
                var dataRows = values ? values.filter(function(row) {
                    return row && row.length >= 2 && row[0] && String(row[0]).trim() !== '' && row[1] && String(row[1]).trim() !== '';
                }) : [];
                
                if (dataRows && dataRows.length > 1) {
                    var lastRow = dataRows[dataRows.length - 1];
                    var lastDate = lastRow[0];
                    var odometerValue = lastRow[1];
                    lastOdometer = parseFloat(String(odometerValue).replace(/,/g, ''));
                    
                    if (lastDate && lastOdometer) {
                        document.getElementById('lastFillInfo').style.display = 'block';
                        document.getElementById('lastFillDetails').innerHTML = 'üìÖ Date: ' + lastDate + '<br>üöó Odometer (prior): ' + lastOdometer.toLocaleString() + ' miles';
                        showStatus('Last fill-up loaded successfully', 'success');
                    }
                    
                    var milesFillValues = [];
                    var pricePerGalValues = [];
                    var startIndex = Math.max(1, dataRows.length - 4);
                    
                    for (var i = startIndex; i < dataRows.length; i++) {
                        var milesFillValue = dataRows[i][2];
                        if (milesFillValue && !isNaN(milesFillValue)) {
                            milesFillValues.push(parseFloat(String(milesFillValue).replace(/,/g, '')));
                        }
                        var priceValue = dataRows[i][6];
                        if (priceValue) {
                            var cleanedPrice = String(priceValue).replace(/[\$,\s]/g, '').trim();
                            if (cleanedPrice && !isNaN(cleanedPrice)) {
                                pricePerGalValues.push(parseFloat(cleanedPrice));
                            }
                        }
                    }
                    
                    if (milesFillValues.length > 0) {
                        var sum = 0;
                        for (var i = 0; i < milesFillValues.length; i++) sum += milesFillValues[i];
                        var averageMilesFill = sum / milesFillValues.length;
                        var estimatedOdometer = lastOdometer + Math.round(averageMilesFill);
                        document.getElementById('odometer').value = estimatedOdometer.toLocaleString('en-US');
                        document.getElementById('odometerValue').value = estimatedOdometer;
                        calculateValues();
                    }
                    
                    if (pricePerGalValues.length > 0) {
                        var sum = 0;
                        for (var i = 0; i < pricePerGalValues.length; i++) sum += pricePerGalValues[i];
                        var averagePrice = sum / pricePerGalValues.length;
                        document.getElementById('pricePerGal').value = averagePrice.toFixed(3);
                    }
                    
                    var uniqueLocations = [];
                    for (var i = 2; i < dataRows.length; i++) {
                        var location = dataRows[i][7];
                        if (location && location.trim() && uniqueLocations.indexOf(location.trim()) === -1) {
                            uniqueLocations.push(location.trim());
                        }
                    }
                    
                    var datalist = document.getElementById('locationList');
                    datalist.innerHTML = '<option value="COSTCO SOS"><option value="COSTCO GSE">';
                    for (var i = 0; i < uniqueLocations.length; i++) {
                        if (uniqueLocations[i] !== "COSTCO SOS" && uniqueLocations[i] !== "COSTCO GSE") {
                            var option = document.createElement('option');
                            option.value = uniqueLocations[i];
                            datalist.appendChild(option);
                        }
                    }
                } else {
                    showStatus('No previous fill-ups found. This will be your first entry!', 'info');
                }
            });
        }
        
        function loadHistory() {
            showStatus('Loading history...', 'info');
            var spreadsheetId = localStorage.getItem('fuelTracker_spreadsheetId');
            var sheetName = localStorage.getItem('fuelTracker_sheetName');
             + totalCost;
                        
                        var htmlContent = '';
                        htmlContent += '<div class="history-item-date">' + row[0] + '</div>';
                        htmlContent += '<div class="history-item-detail">üöó Odometer: ' + row[1] + ' miles</div>';
                        htmlContent += '<div class="history-item-detail">üìè Miles/Fill: ' + row[2] + ' miles</div>';
                        htmlContent += '<div class="history-item-detail">‚õΩ ' + costLine + '</div>';
                        htmlContent += '<div class="history-item-detail">üìä MPG: ' + row[5] + '</div>';
                        htmlContent += '<div class="history-item-detail">üìç ' + row[7] + '</div>';
                        if (row[8]) {
                            htmlContent += '<div class="history-item-detail" style="font-size: 11px; color: #999;">üïê Recorded: ' + row[8] + '</div>';
                        }
                        if (receiptFileId) {
                            htmlContent += '<button class="receipt-btn" data-fileid="' + receiptFileId + '">üì∑ View Receipt</button>';
                        }
                        item.innerHTML = htmlContent;
                        historyList.appendChild(item);
                    }
                    showStatus('History loaded!', 'success');
                } else {
                    historyList.innerHTML = '<p style="text-align: center; color: #999;">No fuel stops found</p>';
                }
            });
        }
        
        function loadSummary() {
            showStatus('Loading summary statistics...', 'info');
            var spreadsheetId = localStorage.getItem('fuelTracker_spreadsheetId');
            var sheetName = localStorage.getItem('fuelTracker_sheetName');
            
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: spreadsheetId,
                range: sheetName + '!R1:S14'
            }).then(function(response) {
                var values = response.result.values;
                var summaryContent = document.getElementById('summaryContent');
                
                if (values && values.length > 0) {
                    var tableHtml = '<table class="summary-table">';
                    for (var i = 0; i < values.length; i++) {
                        var row = values[i];
                        var label = row[0] || '';
                        var value = row[1] || '';
                        if (label || value) {
                            tableHtml += '<tr><td class="summary-label">' + label + '</td><td class="summary-value">' + value + '</td></tr>';
                        }
                    }
                    tableHtml += '</table>';
                    summaryContent.innerHTML = tableHtml;
                    showStatus('Summary loaded!', 'success');
                } else {
                    summaryContent.innerHTML = '<p style="text-align: center; color: #999;">No summary data found in range R1:S14</p>';
                }
            });
        }
        
        function toggleReceiptImage(fileId, buttonElement) {
            var container = buttonElement.parentElement;
            var img = container.querySelector('.receipt-image');
            
            if (img) {
                img.classList.toggle('show');
                buttonElement.textContent = img.classList.contains('show') ? 'üì∑ Hide Receipt' : 'üì∑ View Receipt';
            } else {
                img = document.createElement('img');
                img.className = 'receipt-image show';
                img.src = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w800';
                img.alt = 'Receipt';
                img.onerror = function() {
                    img.src = 'https://drive.google.com/uc?export=view&id=' + fileId;
                };
                container.appendChild(img);
                buttonElement.textContent = 'üì∑ Hide Receipt';
            }
        }
        
        function getOrCreateDriveFolder() {
            if (driveFolder) return Promise.resolve(driveFolder);
            
            return gapi.client.request({
                path: '/drive/v3/files',
                method: 'GET',
                params: {
                    q: "name='Fuel Receipts' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                    fields: 'files(id, name)'
                }
            }).then(function(response) {
                if (response.result.files && response.result.files.length > 0) {
                    driveFolder = response.result.files[0].id;
                    return driveFolder;
                }
                return gapi.client.request({
                    path: '/drive/v3/files',
                    method: 'POST',
                    body: {
                        name: 'Fuel Receipts',
                        mimeType: 'application/vnd.google-apps.folder'
                    }
                }).then(function(createResponse) {
                    driveFolder = createResponse.result.id;
                    return driveFolder;
                });
            });
        }
        
        function uploadReceiptToDrive(file, fuelDate) {
            if (!file) return Promise.resolve(null);
            
            return getOrCreateDriveFolder().then(function(folderId) {
                var timestamp = new Date().getTime();
                var fileName = 'Receipt_' + fuelDate + '_' + timestamp + '.jpg';
                var metadata = {
                    name: fileName,
                    mimeType: file.type,
                    parents: [folderId]
                };
                var formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', file);
                
                return fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                    method: 'POST',
                    headers: {'Authorization': 'Bearer ' + accessToken},
                    body: formData
                }).then(function(response) {
                    return response.json();
                }).then(function(result) {
                    var fileId = result.id;
                    return gapi.client.request({
                        path: '/drive/v3/files/' + fileId + '/permissions',
                        method: 'POST',
                        body: {role: 'reader', type: 'anyone'}
                    }).then(function() {
                        return fileId;
                    });
                });
            });
        }
        
        function writeToSheet(data) {
            var spreadsheetId = localStorage.getItem('fuelTracker_spreadsheetId');
            var sheetName = localStorage.getItem('fuelTracker_sheetName');
            
            return gapi.client.sheets.spreadsheets.get({
                spreadsheetId: spreadsheetId
            }).then(function(sheetMetadata) {
                var sheetId = 0;
                for (var i = 0; i < sheetMetadata.result.sheets.length; i++) {
                    if (sheetMetadata.result.sheets[i].properties.title === sheetName) {
                        sheetId = sheetMetadata.result.sheets[i].properties.sheetId;
                        break;
                    }
                }
                
                return gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: spreadsheetId,
                    range: sheetName + '!B:Z'
                }).then(function(response) {
                    var values = response.result.values;
                    var nextRow = values ? values.length + 1 : 1;
                    var previousRow = nextRow - 1;
                    
                    var promise = Promise.resolve();
                    if (previousRow > 0) {
                        promise = gapi.client.sheets.spreadsheets.batchUpdate({
                            spreadsheetId: spreadsheetId,
                            resource: {
                                requests: [{
                                    copyPaste: {
                                        source: {
                                            sheetId: sheetId,
                                            startRowIndex: previousRow - 1,
                                            endRowIndex: previousRow,
                                            startColumnIndex: 1,
                                            endColumnIndex: 30
                                        },
                                        destination: {
                                            sheetId: sheetId,
                                            startRowIndex: nextRow - 1,
                                            endRowIndex: nextRow,
                                            startColumnIndex: 1,
                                            endColumnIndex: 30
                                        },
                                        pasteType: 'PASTE_FORMULA'
                                    }
                                }]
                            }
                        });
                    }
                    
                    return promise.then(function() {
                        var now = new Date();
                        var timestamp = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0') + ' ' + String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0') + ':' + String(now.getSeconds()).padStart(2, '0');
                        
                        var batchData = [
                            {range: sheetName + '!B' + nextRow + ':F' + nextRow, values: [[data.date, data.odometer, data.milesFill, data.fuelType, data.gallons]]},
                            {range: sheetName + '!H' + nextRow + ':J' + nextRow, values: [[data.pricePerGal, data.location, timestamp]]}
                        ];
                        
                        if (data.receiptFileId) {
                            batchData.push({range: sheetName + '!P' + nextRow, values: [[data.receiptFileId]]});
                        }
                        
                        return gapi.client.sheets.spreadsheets.values.batchUpdate({
                            spreadsheetId: spreadsheetId,
                            resource: {valueInputOption: 'USER_ENTERED', data: batchData}
                        });
                    });
                });
            });
        }
        
        setTodayDate();
        
        document.getElementById('signInBtn').addEventListener('click', handleAuthClick);
        document.getElementById('signOutBtn').addEventListener('click', handleSignoutClick);
        document.getElementById('logTabBtn').addEventListener('click', function() { showTab('log'); });
        document.getElementById('historyTabBtn').addEventListener('click', function() { showTab('history'); });
        document.getElementById('summaryTabBtn').addEventListener('click', function() { showTab('summary'); });
        document.getElementById('shortcutsTabBtn').addEventListener('click', function() { showTab('shortcuts'); });
        document.getElementById('refreshHistoryBtn').addEventListener('click', loadHistory);
        document.getElementById('refreshSummaryBtn').addEventListener('click', loadSummary);
        document.getElementById('shortcutInstructionsBtn').addEventListener('click', function() {
            var instructions = document.getElementById('shortcutInstructions');
            instructions.style.display = instructions.style.display === 'none' ? 'block' : 'none';
        });
        
        document.getElementById('odoMinusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('odometerValue').value) || 0;
            var newValue = currentValue - 1;
            if (newValue >= 0) {
                document.getElementById('odometer').value = newValue.toLocaleString('en-US');
                document.getElementById('odometerValue').value = newValue;
                calculateValues();
            }
        });
        
        document.getElementById('odoPlusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('odometerValue').value) || 0;
            var newValue = currentValue + 1;
            document.getElementById('odometer').value = newValue.toLocaleString('en-US');
            document.getElementById('odometerValue').value = newValue;
            calculateValues();
        });
        
        document.getElementById('milesMinusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('milesFill').value) || 0;
            var newValue = currentValue - 0.1;
            if (newValue >= 0) {
                document.getElementById('milesFill').value = newValue.toFixed(1);
                var expectedGallons = newValue / 26.1;
                document.getElementById('gallons').value = expectedGallons.toFixed(3);
                calculateMPG();
            }
        });
        
        document.getElementById('milesPlusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('milesFill').value) || 0;
            var newValue = currentValue + 0.1;
            document.getElementById('milesFill').value = newValue.toFixed(1);
            var expectedGallons = newValue / 26.1;
            document.getElementById('gallons').value = expectedGallons.toFixed(3);
            calculateMPG();
        });
        
        document.getElementById('gallonsMinusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('gallons').value) || 0;
            var newValue = currentValue - 0.1;
            if (newValue >= 0) {
                document.getElementById('gallons').value = newValue.toFixed(3);
                calculateMPG();
            }
        });
        
        document.getElementById('gallonsPlusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('gallons').value) || 0;
            var newValue = currentValue + 0.1;
            document.getElementById('gallons').value = newValue.toFixed(3);
            calculateMPG();
        });
        
        document.getElementById('priceMinusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('pricePerGal').value) || 0;
            var newValue = currentValue - 0.10;
            if (newValue >= 0) {
                document.getElementById('pricePerGal').value = newValue.toFixed(3);
            }
        });
        
        document.getElementById('pricePlusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('pricePerGal').value) || 0;
            var newValue = currentValue + 0.10;
            document.getElementById('pricePerGal').value = newValue.toFixed(3);
        });
        
        document.getElementById('odometer').addEventListener('input', function(e) {
            var value = e.target.value.replace(/,/g, '');
            if (value && !isNaN(value)) {
                var numValue = parseFloat(value);
                document.getElementById('odometerValue').value = numValue;
                e.target.value = numValue.toLocaleString('en-US');
            } else {
                document.getElementById('odometerValue').value = '';
            }
            calculateValues();
        });
        
        document.getElementById('location').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
        
        document.getElementById('receipt').addEventListener('change', function(e) {
            var file = e.target.files[0];
            var preview = document.getElementById('receiptPreview');
            if (file) {
                var reader = new FileReader();
                reader.onload = function(event) {
                    var img = document.createElement('img');
                    img.src = event.target.result;
                    img.alt = 'Receipt Preview';
                    preview.innerHTML = '';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
            }
        });
        
        document.getElementById('milesFill').addEventListener('input', function(e) {
            var milesFill = parseFloat(e.target.value);
            if (milesFill > 0) {
                var expectedGallons = milesFill / 26.1;
                document.getElementById('gallons').value = expectedGallons.toFixed(3);
                calculateMPG();
            }
        });
        
        document.getElementById('gallons').addEventListener('input', calculateMPG);
        
        document.getElementById('fuelForm').addEventListener('submit', function(e) {
            e.preventDefault();
            var currentOdometer = parseFloat(document.getElementById('odometerValue').value);
            if (lastOdometer && currentOdometer <= lastOdometer) {
                showStatus('Cannot submit: Current odometer must be greater than prior odometer', 'error');
                return;
            }
            
            var dateValue = document.getElementById('date').value;
            var receiptFile = document.getElementById('receipt').files[0];
            showStatus('Saving to Google Sheets...', 'info');
            
            var uploadPromise = receiptFile ? uploadReceiptToDrive(receiptFile, dateValue) : Promise.resolve(null);
            
            uploadPromise.then(function(receiptFileId) {
                var formData = {
                    date: dateValue,
                    odometer: currentOdometer,
                    milesFill: parseFloat(document.getElementById('milesFill').value) || '',
                    fuelType: document.getElementById('fuelType').value,
                    gallons: parseFloat(document.getElementById('gallons').value),
                    pricePerGal: parseFloat(document.getElementById('pricePerGal').value),
                    location: document.getElementById('location').value,
                    receiptFileId: receiptFileId
                };
                
                return writeToSheet(formData);
            }).then(function() {
                showStatus('Fuel stop logged successfully!', 'success');
                lastOdometer = parseFloat(document.getElementById('odometerValue').value);
                document.getElementById('fuelForm').reset();
                document.getElementById('receiptPreview').innerHTML = '';
                setTodayDate();
                document.getElementById('fuelType').value = 'R87';
                document.getElementById('gallons').value = '13.500';
                document.getElementById('location').value = 'COSTCO SOS';
                document.getElementById('odometer').value = '';
                document.getElementById('odometerValue').value = '';
                setTimeout(function() {
                    showStatus('Ready for next entry', 'info');
                }, 2000);
            }).catch(function(error) {
                console.error('Error loading last odometer:', error);
                showStatus('Could not load previous data.', 'info');
            });
        }
        
        function loadHistory() {
            showStatus('Loading history...', 'info');
            var spreadsheetId = localStorage.getItem('fuelTracker_spreadsheetId');
            var sheetName = localStorage.getItem('fuelTracker_sheetName');
            
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: spreadsheetId,
                range: sheetName + '!B:P'
            }).then(function(response) {
                var values = response.result.values;
                var dataRows = values ? values.filter(function(row) {
                    return row && row.length >= 2 && row[0] && String(row[0]).trim() !== '' && row[1] && String(row[1]).trim() !== '';
                }) : [];
                
                var historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                
                if (dataRows && dataRows.length > 1) {
                    for (var i = dataRows.length - 1; i >= 1; i--) {
                        var row = dataRows[i];
                        var gallons = parseFloat(row[4]) || 0;
                        var pricePerGal = parseFloat(String(row[6]).replace(/[\$,\s]/g, '')) || 0;
                        var totalCost = (gallons * pricePerGal).toFixed(2);
                        var receiptFileId = row[14] || null;
                        
                        var item = document.createElement('div');
                        item.className = 'history-item';
                        var costLine = row[4] + ' gallons @ ' + row[6] + '/gal = $' + totalCost;
                        
                        var htmlContent = '';
                        htmlContent += '<div class="history-item-date">' + row[0] + '</div>';
                        htmlContent += '<div class="history-item-detail">üöó Odometer: ' + row[1] + ' miles</div>';
                        htmlContent += '<div class="history-item-detail">üìè Miles/Fill: ' + row[2] + ' miles</div>';
                        htmlContent += '<div class="history-item-detail">‚õΩ ' + costLine + '</div>';
                        htmlContent += '<div class="history-item-detail">üìä MPG: ' + row[5] + '</div>';
                        htmlContent += '<div class="history-item-detail">üìç ' + row[7] + '</div>';
                        if (row[8]) {
                            htmlContent += '<div class="history-item-detail" style="font-size: 11px; color: #999;">üïê Recorded: ' + row[8] + '</div>';
                        }
                        if (receiptFileId) {
                            htmlContent += '<button class="receipt-btn" data-fileid="' + receiptFileId + '">üì∑ View Receipt</button>';
                        }
                        item.innerHTML = htmlContent;
                        historyList.appendChild(item);
                    }
                    showStatus('History loaded!', 'success');
                } else {
                    historyList.innerHTML = '<p style="text-align: center; color: #999;">No fuel stops found</p>';
                }
            });
        }
        
        function loadSummary() {
            showStatus('Loading summary statistics...', 'info');
            var spreadsheetId = localStorage.getItem('fuelTracker_spreadsheetId');
            var sheetName = localStorage.getItem('fuelTracker_sheetName');
            
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: spreadsheetId,
                range: sheetName + '!R1:S14'
            }).then(function(response) {
                var values = response.result.values;
                var summaryContent = document.getElementById('summaryContent');
                
                if (values && values.length > 0) {
                    var tableHtml = '<table class="summary-table">';
                    for (var i = 0; i < values.length; i++) {
                        var row = values[i];
                        var label = row[0] || '';
                        var value = row[1] || '';
                        if (label || value) {
                            tableHtml += '<tr><td class="summary-label">' + label + '</td><td class="summary-value">' + value + '</td></tr>';
                        }
                    }
                    tableHtml += '</table>';
                    summaryContent.innerHTML = tableHtml;
                    showStatus('Summary loaded!', 'success');
                } else {
                    summaryContent.innerHTML = '<p style="text-align: center; color: #999;">No summary data found in range R1:S14</p>';
                }
            });
        }
        
        function toggleReceiptImage(fileId, buttonElement) {
            var container = buttonElement.parentElement;
            var img = container.querySelector('.receipt-image');
            
            if (img) {
                img.classList.toggle('show');
                buttonElement.textContent = img.classList.contains('show') ? 'üì∑ Hide Receipt' : 'üì∑ View Receipt';
            } else {
                img = document.createElement('img');
                img.className = 'receipt-image show';
                img.src = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w800';
                img.alt = 'Receipt';
                img.onerror = function() {
                    img.src = 'https://drive.google.com/uc?export=view&id=' + fileId;
                };
                container.appendChild(img);
                buttonElement.textContent = 'üì∑ Hide Receipt';
            }
        }
        
        function getOrCreateDriveFolder() {
            if (driveFolder) return Promise.resolve(driveFolder);
            
            return gapi.client.request({
                path: '/drive/v3/files',
                method: 'GET',
                params: {
                    q: "name='Fuel Receipts' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                    fields: 'files(id, name)'
                }
            }).then(function(response) {
                if (response.result.files && response.result.files.length > 0) {
                    driveFolder = response.result.files[0].id;
                    return driveFolder;
                }
                return gapi.client.request({
                    path: '/drive/v3/files',
                    method: 'POST',
                    body: {
                        name: 'Fuel Receipts',
                        mimeType: 'application/vnd.google-apps.folder'
                    }
                }).then(function(createResponse) {
                    driveFolder = createResponse.result.id;
                    return driveFolder;
                });
            });
        }
        
        function uploadReceiptToDrive(file, fuelDate) {
            if (!file) return Promise.resolve(null);
            
            return getOrCreateDriveFolder().then(function(folderId) {
                var timestamp = new Date().getTime();
                var fileName = 'Receipt_' + fuelDate + '_' + timestamp + '.jpg';
                var metadata = {
                    name: fileName,
                    mimeType: file.type,
                    parents: [folderId]
                };
                var formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', file);
                
                return fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                    method: 'POST',
                    headers: {'Authorization': 'Bearer ' + accessToken},
                    body: formData
                }).then(function(response) {
                    return response.json();
                }).then(function(result) {
                    var fileId = result.id;
                    return gapi.client.request({
                        path: '/drive/v3/files/' + fileId + '/permissions',
                        method: 'POST',
                        body: {role: 'reader', type: 'anyone'}
                    }).then(function() {
                        return fileId;
                    });
                });
            });
        }
        
        function writeToSheet(data) {
            var spreadsheetId = localStorage.getItem('fuelTracker_spreadsheetId');
            var sheetName = localStorage.getItem('fuelTracker_sheetName');
            
            return gapi.client.sheets.spreadsheets.get({
                spreadsheetId: spreadsheetId
            }).then(function(sheetMetadata) {
                var sheetId = 0;
                for (var i = 0; i < sheetMetadata.result.sheets.length; i++) {
                    if (sheetMetadata.result.sheets[i].properties.title === sheetName) {
                        sheetId = sheetMetadata.result.sheets[i].properties.sheetId;
                        break;
                    }
                }
                
                return gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: spreadsheetId,
                    range: sheetName + '!B:Z'
                }).then(function(response) {
                    var values = response.result.values;
                    var nextRow = values ? values.length + 1 : 1;
                    var previousRow = nextRow - 1;
                    
                    var promise = Promise.resolve();
                    if (previousRow > 0) {
                        promise = gapi.client.sheets.spreadsheets.batchUpdate({
                            spreadsheetId: spreadsheetId,
                            resource: {
                                requests: [{
                                    copyPaste: {
                                        source: {
                                            sheetId: sheetId,
                                            startRowIndex: previousRow - 1,
                                            endRowIndex: previousRow,
                                            startColumnIndex: 1,
                                            endColumnIndex: 30
                                        },
                                        destination: {
                                            sheetId: sheetId,
                                            startRowIndex: nextRow - 1,
                                            endRowIndex: nextRow,
                                            startColumnIndex: 1,
                                            endColumnIndex: 30
                                        },
                                        pasteType: 'PASTE_FORMULA'
                                    }
                                }]
                            }
                        });
                    }
                    
                    return promise.then(function() {
                        var now = new Date();
                        var timestamp = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0') + ' ' + String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0') + ':' + String(now.getSeconds()).padStart(2, '0');
                        
                        var batchData = [
                            {range: sheetName + '!B' + nextRow + ':F' + nextRow, values: [[data.date, data.odometer, data.milesFill, data.fuelType, data.gallons]]},
                            {range: sheetName + '!H' + nextRow + ':J' + nextRow, values: [[data.pricePerGal, data.location, timestamp]]}
                        ];
                        
                        if (data.receiptFileId) {
                            batchData.push({range: sheetName + '!P' + nextRow, values: [[data.receiptFileId]]});
                        }
                        
                        return gapi.client.sheets.spreadsheets.values.batchUpdate({
                            spreadsheetId: spreadsheetId,
                            resource: {valueInputOption: 'USER_ENTERED', data: batchData}
                        });
                    });
                });
            });
        }
        
        setTodayDate();
        
        document.getElementById('signInBtn').addEventListener('click', handleAuthClick);
        document.getElementById('signOutBtn').addEventListener('click', handleSignoutClick);
        document.getElementById('logTabBtn').addEventListener('click', function() { showTab('log'); });
        document.getElementById('historyTabBtn').addEventListener('click', function() { showTab('history'); });
        document.getElementById('summaryTabBtn').addEventListener('click', function() { showTab('summary'); });
        document.getElementById('shortcutsTabBtn').addEventListener('click', function() { showTab('shortcuts'); });
        document.getElementById('refreshHistoryBtn').addEventListener('click', loadHistory);
        document.getElementById('refreshSummaryBtn').addEventListener('click', loadSummary);
        document.getElementById('shortcutInstructionsBtn').addEventListener('click', function() {
            var instructions = document.getElementById('shortcutInstructions');
            instructions.style.display = instructions.style.display === 'none' ? 'block' : 'none';
        });
        
        document.getElementById('odoMinusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('odometerValue').value) || 0;
            var newValue = currentValue - 1;
            if (newValue >= 0) {
                document.getElementById('odometer').value = newValue.toLocaleString('en-US');
                document.getElementById('odometerValue').value = newValue;
                calculateValues();
            }
        });
        
        document.getElementById('odoPlusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('odometerValue').value) || 0;
            var newValue = currentValue + 1;
            document.getElementById('odometer').value = newValue.toLocaleString('en-US');
            document.getElementById('odometerValue').value = newValue;
            calculateValues();
        });
        
        document.getElementById('milesMinusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('milesFill').value) || 0;
            var newValue = currentValue - 0.1;
            if (newValue >= 0) {
                document.getElementById('milesFill').value = newValue.toFixed(1);
                var expectedGallons = newValue / 26.1;
                document.getElementById('gallons').value = expectedGallons.toFixed(3);
                calculateMPG();
            }
        });
        
        document.getElementById('milesPlusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('milesFill').value) || 0;
            var newValue = currentValue + 0.1;
            document.getElementById('milesFill').value = newValue.toFixed(1);
            var expectedGallons = newValue / 26.1;
            document.getElementById('gallons').value = expectedGallons.toFixed(3);
            calculateMPG();
        });
        
        document.getElementById('gallonsMinusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('gallons').value) || 0;
            var newValue = currentValue - 0.1;
            if (newValue >= 0) {
                document.getElementById('gallons').value = newValue.toFixed(3);
                calculateMPG();
            }
        });
        
        document.getElementById('gallonsPlusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('gallons').value) || 0;
            var newValue = currentValue + 0.1;
            document.getElementById('gallons').value = newValue.toFixed(3);
            calculateMPG();
        });
        
        document.getElementById('priceMinusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('pricePerGal').value) || 0;
            var newValue = currentValue - 0.10;
            if (newValue >= 0) {
                document.getElementById('pricePerGal').value = newValue.toFixed(3);
            }
        });
        
        document.getElementById('pricePlusBtn').addEventListener('click', function() {
            var currentValue = parseFloat(document.getElementById('pricePerGal').value) || 0;
            var newValue = currentValue + 0.10;
            document.getElementById('pricePerGal').value = newValue.toFixed(3);
        });
        
        document.getElementById('odometer').addEventListener('input', function(e) {
            var value = e.target.value.replace(/,/g, '');
            if (value && !isNaN(value)) {
                var numValue = parseFloat(value);
                document.getElementById('odometerValue').value = numValue;
                e.target.value = numValue.toLocaleString('en-US');
            } else {
                document.getElementById('odometerValue').value = '';
            }
            calculateValues();
        });
        
        document.getElementById('location').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
        
        document.getElementById('receipt').addEventListener('change', function(e) {
            var file = e.target.files[0];
            var preview = document.getElementById('receiptPreview');
            if (file) {
                var reader = new FileReader();
                reader.onload = function(event) {
                    var img = document.createElement('img');
                    img.src = event.target.result;
                    img.alt = 'Receipt Preview';
                    preview.innerHTML = '';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
            }
        });
        
        document.getElementById('milesFill').addEventListener('input', function(e) {
            var milesFill = parseFloat(e.target.value);
            if (milesFill > 0) {
                var expectedGallons = milesFill / 26.1;
                document.getElementById('gallons').value = expectedGallons.toFixed(3);
                calculateMPG();
            }
        });
        
        document.getElementById('gallons').addEventListener('input', calculateMPG);
        
        document.getElementById('fuelForm').addEventListener('submit', function(e) {
            e.preventDefault();
            var currentOdometer = parseFloat(document.getElementById('odometerValue').value);
            if (lastOdometer && currentOdometer <= lastOdometer) {
                showStatus('Cannot submit: Current odometer must be greater than prior odometer', 'error');
                return;
            }
            
            var dateValue = document.getElementById('date').value;
            var receiptFile = document.getElementById('receipt').files[0];
            showStatus('Saving to Google Sheets...', 'info');
            
            var uploadPromise = receiptFile ? uploadReceiptToDrive(receiptFile, dateValue) : Promise.resolve(null);
            
            uploadPromise.then(function(receiptFileId) {
                var formData = {
                    date: dateValue,
                    odometer: currentOdometer,
                    milesFill: parseFloat(document.getElementById('milesFill').value) || '',
                    fuelType: document.getElementById('fuelType').value,
                    gallons: parseFloat(document.getElementById('gallons').value),
                    pricePerGal: parseFloat(document.getElementById('pricePerGal').value),
                    location: document.getElementById('location').value,
                    receiptFileId: receiptFileId
                };
                
                return writeToSheet(formData);
            }).then(function() {
                showStatus('Fuel stop logged successfully!', 'success');
                lastOdometer = parseFloat(document.getElementById('odometerValue').value);
                document.getElementById('fuelForm').reset();
                document.getElementById('receiptPreview').innerHTML = '';
                setTodayDate();
                document.getElementById('fuelType').value = 'R87';
                document.getElementById('gallons').value = '13.500';
                document.getElementById('location').value = 'COSTCO SOS';
                document.getElementById('odometer').value = '';
                document.getElementById('odometerValue').value = '';
                setTimeout(function() {
                    showStatus('Ready for next entry', 'info');
                }, 2000);
            }).catch(function(error) {
                showStatus('Error saving: ' + error.message, 'error');
                console.error('Save error:', error);
            });
        });
        
        document.getElementById('historyList').addEventListener('click', function(e) {
            if (e.target.classList.contains('receipt-btn')) {
                var fileId = e.target.getAttribute('data-fileid');
                toggleReceiptImage(fileId, e.target);
            }
        });
        
        window.addEventListener('load', function() {
            var savedClientId = localStorage.getItem('fuelTracker_clientId');
            var savedApiKey = localStorage.getItem('fuelTracker_apiKey');
            var savedSpreadsheetId = localStorage.getItem('fuelTracker_spreadsheetId');
            var savedSheetName = localStorage.getItem('fuelTracker_sheetName');
            
            if (savedClientId) document.getElementById('clientId').value = savedClientId;
            if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
            if (savedSpreadsheetId) document.getElementById('spreadsheetId').value = savedSpreadsheetId;
            if (savedSheetName) document.getElementById('sheetName').value = savedSheetName;
        });
    </script>
    
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
</body>
</html>
